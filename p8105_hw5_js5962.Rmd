---
title: "p8105_hw5_js5962"
output: github_document
---

```{r setup,echo = FALSE, message = FALSE}
library(tidyverse)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = 0.6,
  out.width = "90%"
)

options(
  ggplot2.continuous.color = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_color_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1


a) Import the data and clean.

```{r import_data}
homicide_df =
  read.csv("homicide-data.csv", na = c("", "Unknown")) 
```

Describe the raw data: The dataset homicide_data is collected by _The Washington Post_ on homicides in 50 large U.S. cities. The data contains `r nrow(homicide_df)` rows and `r ncol(homicide_df)` columns. Each row represents one case. Variables describe the report data, location, victim's information and disposition od the cases.

```{r dataclean}
homicide_clean =
  homicide_df %>% 
  mutate(city_state = str_c(city, ",", state),#create variable
         result = case_when(
           disposition == "Closed without arrest" ~ "unsolved",
           disposition == "Open/No arrest" ~ "unsolved",
           disposition == "Closed by arrest" ~ "solved"
         )) %>% 
  relocate(city_state) %>% 
  filter(city_state != "Tulsa,AL") 
homicide_clean %>% 
  select(-city, -state) %>% #summarize numbers
  group_by(city_state) %>% 
  summarize(unsolved = sum(result == "unsolved"),#summarize numbers
            n = n()) %>% 
  knitr::kable()
```

b) use the prop.test function to estimate the proportion of homicides that are unsolved in the city of Baltimore, MD.

```{r blatimore}
baltimore_df = homicide_clean %>% 
  filter(city_state == "Baltimore,MD")

baltimore_unsolved =     
  baltimore_df %>% 
  summarize(unsolved = sum(result == "unsolved"),
            n = n())
baltimore_prop =
  prop.test(x = baltimore_unsolved %>% pull(unsolved), 
          n = baltimore_unsolved %>% pull(n))
tidy_df = baltimore_prop %>% 
  broom::tidy()
tidy_df
# pull the estimated proportion and confidence intervals from the resulting tidy dataframe
tidy_df %>% 
  select(estimate, conf.low, conf.high)
```

c) Run prop.test for each of the cities in your dataset, and extract both the proportion of unsolved homicides and the confidence interval for each.

Firstly build the function.

```{r prop_function}
prop_test = function(city_df){
  
  city_unsolved =     
  city_df %>% 
  summarize(unsolved = sum(result == "unsolved"),
            n = n())
  
city_prop =
  prop.test(x = baltimore_unsolved %>% pull(unsolved), 
          n = baltimore_unsolved %>% pull(n))
return(city_prop)
}
```

We iterate by mapping.

```{r iterate_city, warning = FALSE}
result_df =
  homicide_clean %>% 
  nest(data = uid:result) %>% 
  mutate(
    test_result = map(data, prop_test),
    tidy_result = map(test_result, broom::tidy)
  ) %>% 
  select(city_state, tidy_result) %>% 
  unnest(tidy_result) %>% 
  select(city_state, estimate, conf.low, conf.high)
show(result_df)
```

use map2.

```{r second_method}
result_df2 =
  homicide_clean %>% 
  select(-city, -state) %>% 
  group_by(city_state) %>% 
  summarize(unsolved = sum(result == "unsolved"),
            n = n()) %>% 
  mutate(
    test_result = map2(unsolved, n, prop.test),
    tidy_result = map(test_result, broom::tidy)
  ) %>% 
  select(city_state, tidy_result) %>% 
  unnest(tidy_result) %>% 
  select(city_state, estimate, conf.low, conf.high)
show(result_df2)
```

d) Create a plot that shows the estimates and CIs for each city.

```{r bar_plot}
result_df %>% 
  mutate(
    city_state = fct_reorder(city_state, estimate)
    ) %>% 
   ggplot(aes(x = city_state, y = estimate)) +
   geom_point() +
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
   labs(title = "Unsolved crime proportion and confidence interval in cities") +
  theme(plot.title = element_text(hjust = 0.5))
```


